# Examples of Knowledge Grap exploitation using R - with visualization included

library(SPARQL)
library(tidyverse)
library(ggplot2)

if(!require(devtools)) install.packages("devtools")
devtools::install_github("thomasp85/patchwork")
library(patchwork)

# First analysis query - most common software per year 
gesis <- "https://data.gesis.org/softwarekg/sparql"
res.overview <- SPARQL(url=gesis, 
              query= "select ?n ?y (count(?n) as ?count) 
              WHERE { 
              ?s rdf:type <http://schema.org/SoftwareApplication> .   
              ?s <http://schema.org/name> ?n . 
              ?m <http://data.gesis.org/softwarekg/software> ?s . 
              ?p <http://schema.org/mentions> ?m . 
              ?p <http://purl.org/dc/elements/1.1/date> ?y . 
              } 
              GROUP BY ?n ?y
              HAVING (count(?n) > 1)
              ORDER by DESC(?count)")$results


# or load from file - if the query was done outside of R
# res.overview <- read.csv2(file="data/queryOverview.csv", header=TRUE, sep=',')

res.overview %>%
  dplyr::mutate(n=factor(n), y = as.integer(y)) %>%
  dim(.)

year2date <- function(y){
  as.Date(paste0(as.character(y),"-01-01"), "%Y-%m-%d")
}

res.overview %>%
  dplyr::mutate(n=factor(n), y = year2date(y))  %>%
  dplyr::group_by(n) %>%
  dplyr::mutate(s=sum(count)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(s > 1690) ->
  res.overview
  
res.overview %>%
  dplyr::group_by(y) %>%
  dplyr::mutate(c2 = count/sum(count)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(y>=year2date(2007)) %>%
  ggplot(. , aes(y,c2)) + 
    #geom_bar(aes(fill=n), stat = 'identity') +
    geom_line(aes(color=n)) +
    theme_minimal(base_size = 12) + 
    theme(legend.position = 'top') + 
    scale_x_date(breaks='year', date_labels = '%Y') + 
    xlab('year') + 
    ylab('Relative Frequency') +
    scale_color_brewer(name='Software', palette='Paired') +
    guides(color=guide_legend(nrow=2,byrow=TRUE)) ->
    p.relative
    
res.overview %>%
  dplyr::filter(y>=year2date(2007)) %>%
  ggplot(. , aes(y,count)) + 
  #geom_bar(aes(fill=n), stat = 'identity') + 
  geom_line(aes(color=n)) +
  xlab('year') + 
  ylab('Absolute Frequency') +
  scale_x_date(breaks='year', date_labels = '%Y') + 
  scale_color_brewer(palette='Paired') +
  theme_minimal(base_size = 12) + 
  theme(legend.position = 'none') ->
  p.absolute

p <- p.relative +  p.absolute + plot_layout(ncol = 1)
ggsave("software_counts.png", p)  

# Second analysis query (first half) - how much of used software is freely available
query.free <- "select count(?n) as ?count ?free ?y 
              WHERE { 
              ?s rdf:type <http://schema.org/SoftwareApplication> . 
              ?s <http://data.gesis.org/softwarekg/freeAvailable> ?free .
              ?s <http://schema.org/name> ?n . 
              ?m <http://data.gesis.org/softwarekg/software> ?s . 
              ?p <http://schema.org/mentions> ?m . 
              ?p <http://purl.org/dc/elements/1.1/date> ?y . 
              } 
              GROUP BY ?y ?free"

res.free <- SPARQL(url = gesis, query = query.free)$results
#res.free <-  read.csv2(file="data/queryFree.csv", header=TRUE, sep=',')

# Second analysis query (second half) - how much of used software allows code inspection
query.source <- "select count(?n) as ?count ?source ?y 
              WHERE { 
              ?s rdf:type <http://schema.org/SoftwareApplication> . 
              ?s <http://data.gesis.org/softwarekg/sourceAvailable> ?source .
              ?s <http://schema.org/name> ?n . 
              ?m <http://data.gesis.org/softwarekg/software> ?s . 
              ?p <http://schema.org/mentions> ?m . 
              ?p <http://purl.org/dc/elements/1.1/date> ?y . 
              } 
              GROUP BY ?y ?source"

res.source <- SPARQL(url = gesis, query = query.source)$results
#res.source <- read.csv2(file="data/querySource.csv", header=TRUE, sep=',')

res.free %>% 
  dplyr::mutate(y = year2date(y), available='Free') %>%
  dplyr::filter(free == 'true') %>%
  dplyr::select(-free) ->
  free

res.free %>% 
  dplyr::mutate(y = year2date(y), available='Commercial') %>%
  dplyr::filter(free == 'false') %>%
  dplyr::select(-free) ->
  commercial

res.source %>% 
  dplyr::mutate(y = year2date(y), available='Source') %>%
  dplyr::filter(source == 'true') %>%
  dplyr::select(-source)->
  source
  
rbind(free, source, commercial) %>%
  ggplot(., aes(y,count)) + 
  geom_line(aes(color=available)) +
  xlab('year') + 
  ylab('Absolute Frequency') +
  scale_x_date(breaks='year', date_labels = '%Y') + 
  scale_color_brewer("Software availability", palette='Set1') +
  theme_minimal(base_size = 12) + 
  theme(legend.position = 'top') ->
  p.available

ggsave(filename = "open_free.png", p.available, width = 10, height = 3)

# Third analysis query - investigate the change from WinBugs to OpenBugs 
query.openbugs <- "select ?y (count(?y) as ?count)
WHERE {
?s <http://schema.org/name> \"OpenBUGS\" .
?m <http://data.gesis.org/softwarekg/software> ?s .
?p <http://schema.org/mentions> ?m .
?p <http://purl.org/dc/elements/1.1/date> ?y .
}
GROUP BY ?y"

query.winbugs <- "select ?y (count(?y) as ?count)
WHERE {
?s <http://schema.org/name> \"WinBUGS\" .
?m <http://data.gesis.org/softwarekg/software> ?s .
?p <http://schema.org/mentions> ?m .
?p <http://purl.org/dc/elements/1.1/date> ?y .
}
GROUP BY ?y"

openbugs <- SPARQL(url = gesis, query = query.openbugs)$results
winbugs <-  SPARQL(url = gesis, query = query.winbugs)$results

openbugs <- read.csv2(file="data/queryReplacement.csv", header=TRUE, sep=',')
winbugs <- read.csv2(file="data/queryWinBUGS.csv", header=TRUE, sep=',')

openbugs$software <- "OpenBUGS"
winbugs$software <- "WinBUGS"

rbind(openbugs, winbugs) %>%
  dplyr::mutate(y = year2date(y)) %>%
  ggplot(., aes(y, count)) + 
    geom_line(aes(color=software, group=software)) +
  xlab('year') + 
  ylab('Absolute Frequency') +
  scale_x_date(breaks='year', date_labels = '%Y') + 
  scale_color_brewer(palette='Set1') +
  theme_minimal(base_size = 12) + 
  theme(legend.position = 'top') ->
  p.bugs

ggsave(filename = "BUGS_usage.png", p.bugs, width = 10, height = 3)
